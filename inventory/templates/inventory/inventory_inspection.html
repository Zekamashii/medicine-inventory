{% extends 'inventory/base.html' %}
{% load custom_filters %}
{% load bootstrap_icons %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <h5 class="mb-0">å®Ÿæ•°ã‚«ã‚¦ãƒ³ãƒˆï¼š<span style="color: #2c3e50;font-weight: bold;">{{ selected_site_name }}</span></h5>
            <a href="https://tbclinic.gitbook.io/ck-stock-knowledge-base/ck-stock-manyuaru/kaunto" class="text-muted ms-2" target="_blank">{% bs_icon 'question-circle' %}</a>
        </div>
    </div>
    {% if selected_site_id %}
        <div class="overall-discrepancy-rate mt-2">
                        <h6>åœ¨åº«å·®ç•°ç‡ï¼š
                            <span id="overall-discrepancy-rate" style="color: {% if overall_discrepancy_rate > 5 %}red{% else %}green{% endif %};">
                    {{ overall_discrepancy_rate|floatformat:2 }} %
                </span>
            </h6>
        </div>
    {% endif %}
    <hr style="text-align:left;margin-left:0">

    <div class="d-flex justify-content-between align-items-start mb-4">
        <div class="flex-grow-1 me-5" style="max-width: 50%;">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-dismissible {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% elif message.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %} mb-0">
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        <p class="mb-0">{{ message }}</p>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="d-flex flex-shrink-0">
            {% if selected_site_id %}
                <button type="button" class="btn btn-warning me-2" id="copy-data-btn" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="ã‚·ã‚¹ãƒ†ãƒ åœ¨åº«æ•°ã‚’ã‚³ãƒ”ãƒ¼">{% bs_icon 'copy' %} ã‚³ãƒ”ãƒ¼</button>
                <button type="button" class="btn btn-secondary me-2" id="clear-data-btn" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="ç¾åœ¨ã®å®Ÿæ•°å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢">{% bs_icon 'x-circle' %} ã‚¯ãƒªã‚¢</button>
                <button type="submit" form="inspection-form" class="btn btn-primary me-2" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="å…¥åŠ›ã—ãŸã‚«ã‚¦ãƒ³ãƒˆæ•°ã‚’ä¿å­˜">{% bs_icon 'floppy' %} ä¿å­˜</button>
                <a href="{% url 'batch-adjustment' %}" class="btn btn-danger me-2" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="å·®ç•°èª¿æ•´ã«ç§»å‹•">{% bs_icon 'wrench-adjustable-circle' %} å·®ç•°èª¿æ•´</a>
                <a href="{% url 'export_inventory_csv' %}" class="btn btn-success me-2" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="å±¥æ­´ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">{% bs_icon 'filetype-csv' %} ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</a>
                <a href="{% url 'inspection-history' %}" class="btn btn-dark me-2" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="å®Ÿæ•°ã‚«ã‚¦ãƒ³ãƒˆå±¥æ­´ã«ç§»å‹•">{% bs_icon 'clock-history' %} å±¥æ­´</a>
                <a href="{% url 'validation' %}" class="btn btn-light" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆã«ç§»å‹•">{% bs_icon 'database-fill-exclamation' %} ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆ</a>
            {% else %}
                <p>ğŸ§™â€â™‚ï¸ æ‹ ç‚¹ã‚’é¸ã‚“ã§ã€ä¸–ç•Œã‚’æ•‘ã„ã¾ã—ã‚‡ã†ï¼ğŸš€</p>
            {% endif %}
        </div>
    </div>

    <form id="inspection-form" method="post" action="{% url 'inspection' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="save">
        <input type="hidden" name="site_id" value="{{ selected_site_id }}">
        <table class="table-auto">
            <thead>
                <tr>
                    <th>åŒ»è–¬å“åãƒ»ç¨®é¡</th>
                    <th>è¨ˆç®—ä¸Šã®åœ¨åº«æ•°</th>
                    <th>å®Ÿåœ¨åº«æ•°{% if latest_inspection_time %} ({{ latest_inspection_time }} by {{ inspector.last_name|default:"" }} {{ inspector.first_name|default:inspector.username }}) {% endif %}</th>
                    <th>å·®ç•°èª¿æ•´</th>
                    <th>ã‚«ã‚¦ãƒ³ãƒˆæ•°å…¥åŠ›</th>
                </tr>
            </thead>
            <tbody>
                {% for category, items in inventory_by_category.items %}
                    {% if items %}
                        <tr class="category-row">
                            <td style="border: 1px solid #ddd; text-align: left; padding: 8px; font-weight: bold; background-color: #2fc3a6;">{{ category }}</td>
                        </tr>
                        {% for drug in items %}
                            {% with history=drug_histories|get_item:drug.name %}
                                {% if history and history.0.discrepancy != 0 %}
                                    <tr class="data-row highlight-discrepancy">
                                {% else %}
                                    <tr class="data-row">
                                {% endif %}
                            {% endwith %}
                                <td style="border: 1px solid #ddd; text-align: left; padding: 8px; padding-left: 20px; max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ drug.name }}</td>
                                <td class="data-cell">
                                    <input type="hidden" name="data_{{ drug.id }}" value="{{ drug.quantity }}" />
                                        {{ drug.quantity }}
                                </td>
                                <td class="saved-data">
                                    {% if drug_histories %}
                                        {% with history=drug_histories|get_item:drug.name %}
                                            {% if history %}
                                                <span>{{ history.0.actual_quantity }}</span>
                                            {% else %}
                                                <span>-</span>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        <span>-</span>
                                    {% endif %}
                                </td>
                                <td class="discrepancy">
                                    {% if inventory_adjusted is True %}
                                        <span>èª¿æ•´æ¸ˆã¿</span>
                                    {% else %}
                                        {% if drug_histories %}
                                            {% with history=drug_histories|get_item:drug.name %}
                                                {% if history %}
                                                    <span>{{ history.0.discrepancy }}</span>
                                                {% else %}
                                                    <span>-</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            <span>-</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    <input type="number" name="manual_input_{{ drug.id }}" class="form-control manual-input" required/>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </form>

    {% if selected_site_id %}
        <div class="d-flex justify-content-end mt-3">
            <button type="submit" form="inspection-form" class="btn btn-primary">çµæœã‚’ä¿å­˜</button>
            <a href="javascript:history.back()" class="btn text-body-tertiary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
        </div>
    {% endif %}
</div>

<style>
    .table-auto {
        width: 100%;
        border-collapse: collapse;
    }

    .table-auto th, .table-auto td {
        border: 1px solid #ddd;
        text-align: left;
        padding: 8px;
        white-space: nowrap;
    }

    .table-auto th {
        background-color: #f2f2f2;
    }

    input[type="number"] {
        width: 80px;
        border: 1px solid #ccc;
        padding: 0px;
        text-align: left;
    }

    .category-row td {
        background-color: #2fc3a6;
        font-weight: bold;
    }

    .highlight-discrepancy {
        background-color: #ffffe0;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var SiteId = "{{ selected_site_id }}";

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    var copyDataBtn = document.getElementById('copy-data-btn');
    var clearDataBtn = document.getElementById('clear-data-btn');

    function calculateDiscrepancyRate() {
        var rows = document.querySelectorAll('.data-row');
        var totalExpected = 0;
        var totalActual = 0;
        var discrepancy = 0;

        rows.forEach(function(row) {
            var expectedQuantity = parseInt(row.querySelector('.data-cell').textContent.trim());
            var actualQuantityElement = row.querySelector('.saved-data span');
            var actualQuantity = actualQuantityElement ? parseInt(actualQuantityElement.textContent.trim()) : NaN;

            if (!isNaN(expectedQuantity) && !isNaN(actualQuantity)) {
                totalExpected += expectedQuantity;
                totalActual += actualQuantity;
            }
        });

            if (discrepancy != null && typeof discrepancy === 'number') {
                if (discrepancy !== 0) {
                    row.classList.add('highlight-discrepancy');
                }
            }

        var overallDiscrepancyRate = 0;
        if (totalExpected > 0) {
            overallDiscrepancyRate = (Math.abs(totalActual - totalExpected) / totalExpected) * 100;
        }

         if (SiteId && SiteId !== "None") {
            var discrepancyRateElement = document.getElementById('overall-discrepancy-rate');
            discrepancyRateElement.textContent = overallDiscrepancyRate.toFixed(2) + ' %';

            if (overallDiscrepancyRate > 5) {
                discrepancyRateElement.style.color = 'red';
            } else {
                discrepancyRateElement.style.color = 'green';
            }
        }
    }

    // Initial calculation of discrepancies
    calculateDiscrepancyRate();

    if (SiteId && SiteId !== "None") {
        copyDataBtn.addEventListener('click', function() {
            var dataCells = document.querySelectorAll('.data-cell');
            var manualInputs = document.querySelectorAll('.manual-input');
            dataCells.forEach(function(cell, index) {
                var dataValue = cell.textContent.trim();
                if (manualInputs[index]) {
                    manualInputs[index].value = dataValue;
                }
            });
        });

        clearDataBtn.addEventListener('click', function() {
            var manualInputs = document.querySelectorAll('.manual-input');
            manualInputs.forEach(function(input) {
                input.value = '';
            });
        });
    }
});

</script>

{% endblock content %}
